---
title: "RHRT: Finding Premature Ventricular Complexes"
author: "Valeria Blesius"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{RHRT: Finding Premature Ventricular Complexes}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

The RHRT package helps you assess **Heart Rate Turbulence** (HRT) in RR intervals. calculates **turbulence onset** (TO), **slope** (TS) and **timing** (TT). It can plot the tachograms and give a reliability table. The **ventricular premature beats** (VPCs) with **coupling** (CPI) and **compensatory interval** (CMI) can either be given with annotations or found on the basis of the filter rules provided by Schmidt et al.^[Website about HRT by Schmidt et al.: http://www.h-r-t.com/hrt/en/calc.html]. The type of average and order of calculation for all parameters can be set.

--------

## Synopsis for the hasty (Quick-start guide)

This chapter sums up the most common functions and parameters needed when using RHRT.

First, the **core function** of RHRT is `vectorToHRT` that finds valid VPCs in RR intervals and returns an `HRTList` object (see chapter *HRTList object* for more information):

```{r, echo = FALSE}
library("RHRT")
data("testdataLong", package = "RHRT")
data <- testdataLong
data("testdataLong_Ann", package = "RHRT")
ann <- testdataLong_Ann
```

### Checking data for HRTs
```{r}
hrtl <- vectorToHRT(data) # data is a numeric vector of RR intervals in msec
```

Every RR interval sequence that matches the needed interval lengths is considered to be a coupling and compensatory interval of a VPC, which can lead to wrong matches. If your data is annotated, you can provide the **annotation data** with the parameters `annotations` and `PVCAnn`.

```{r}
hrtl <- vectorToHRT(data, annotations = ann, PVCAnn = "V") 
  # ann is a vector of characters with the same length as data
```

Other parameters are:

* `numPreRRs` & `numPostRRs` are used to modify the **filter rules** to find HRTs (number of intervals before and after the VPC that have to match the filter criteria).
* `minHRT` is the **minimal number of HRTs** needed to calculate HRT / create a HRTList
* `normHallstrom` defines whether TS should be **normalised** with the method of Hallstrom et al. (see chapter *Normalisation*). 

### Getting HRT parameters or class
```{r}
getResults(hrtl) # get the HRT class of the data
```

Per default `getResults` checks whether all needed HRT parameters can be calculated reliably. This is done via a t-test per parameter value (for more information see chapter *Reliability Check*). If any of the parameter values is **not reliable** `getResults` returns NR (not reliable). 

```{r}
getResults(hrtl, safe = FALSE) # get the HRT class without safety check
```

In addition to the classification system HRT0-2 RHRT implements **HRTA-C** that is based on the three parameters TO, TS and TT. 

```{r}
getResults(hrtl, safe = FALSE, TT = TRUE) # include TT
```

With the parameter `type` you can choose between getting only the HRT **class**, all **parameter values** or the parameter values with the corresponding **p-values** (types "class", "parameter" or "full", respectively).

```{r}
getResults(hrtl, type = "parameter", TT = TRUE) # get the averaged HRT parameters
```

Other parameters are:

* `nTS`: the **normalised TS** is returned or used for classification instead of TS.
* `num`: forces the function to return **numerics** when using `type = parameter`. Depending on the results and your setting of `type` the `getResults` returns characters or numerics.
* `pmax`: changes the needed **significance level** for the parameters to be reliable.

### Plotting

```{r, fig.width=7, fig.height=4}
plot(hrtl, TT = TRUE) # plots the averaged VPCS and all underlying VPCSs in background
```

Per default the VPCS is **zoomed** in. If you want to also see the CPI and CMI use `cropped = FALSE`.

```{r, fig.width=7, fig.height=4}
plot(hrtl, cropped = FALSE) # shows also coupling and compensatory interval
```

--------

## Implementation and Functions

### HRT

#### Slots

An HRT object saves the data of one VPCS and its HRT results. It consists of the following slots:

- **Intervals**
  - `preRRs`: preceding regular intervals, 5 per default
  - `couplRR`: CPI
  - `compRR`: CMI
  - `postRRs`: following regular intervals, 15 per default

- **HRT Parameters**
  - `TO`
  - `TS`
  - `TT`
  - `nTS`: normalised TS, for more Information see chapter *Normalisation of Turbulence Slope*

- **Line coefficients**
  - `intercept`: The intercept of the TS regression line that is needed for plotting
  - `nintercept`: Analogously, the intercept of `nTS`

#### Functions

- **`getRRs`** &nbsp;&nbsp; This function returns all intervals saved in the HRT object. This if helpful for i.e. calculating an averaged VPCS out of a set of HRT objects.

- **`plot`** &nbsp;&nbsp; Per default `plot` displays a zoomed in plot of the VPCS with highlighted TO and TS and a legend given the rounded HRT parameter values. In addition to the common parameters of graphics.plot the method accepts the following parameters:
  - `cropped`: switches between showing a zoomed in version and the full VPCS including CPI and CMI, the default is `TRUE`
  - `add`: adds the plot to the current one
  - `TT`: highlights TT and includes it to the legend
  - `paramsLegend`: switches between showing and hiding the parameter values in the legend, the default is `TRUE`

### HRTList

An HRTList object is created when `vectorToHRT` is called. All HRT parameters are calculated automatically in this process and can be called with the `getHRTParams`-methods.

#### Slots

The HRTList object sums up all HRTs found in the given dataset. The slots are:

- `name`: The name of the object if given to `vectorToHRT`
- `IL`: the average length of all intervals in the given vector 
- `pos`: the indices of the CPIs as found in the given vector
- `HRTs`: list of all HRT objects found
- `avHRT`: an avHRT object averaged from all HRTs
- `nRMSSD`: the HRV parameter nRMSSD calculated from all intervals in the given vector

#### Functions

- **`plot`** &nbsp;&nbsp; Analogously to the plot function of the HRT object HRTList objects can be plotted. This function plots the avHRT and adds the VPCSs of all HRTs as grey lines in the background.

## Methods & Background

### Filter Rules

There are two types of filter rules applied on the interval data:

1) First the filter rules for CPI and CMI are as following:

    * CPI must have a maximal length of 80 % 
    
    * CMI must have a minimal length of 120 %

    Both intervals are compared to the **reference interval (RFI)**. This interval is calculated as the mean of the last five preceding intervals before the coupling interval.
<br><br>

2) Second all "normal" intervals have to be inspected for artefacts. Therefore they have to pass the following rules:

    * The length has to be between 300 ms and 2000 ms
    
    * They must not differ more than 20 % from RFI
    
    * or more than 200 ms from the preceding interval

    The five preceding and fifteen following intervals of CPI and CMI are checked. If any of the intervals do not fit the rules, the complete set is neglected.

### Normalisation of Turbulence Slope

### Reliability Check

### Calculation Order

## Example Pipelines

### Determining the HRT class of a person

### Comparing HRT results with different methodological parameters

--------

Old stuff

## Workflow

At first use `vectorToHRT` to run through your interval data and find interval sequences that fit to the filter rules. Once you have the HRTList object you can get the HRT parameters TO and TS of your dataset and the positions where the HRT objects were found and plot it.

Example workflow:

```{r}
data("testdataVariant", package = "RHRT")

tdVariant <- testdataVariant
hrtlVar <- RHRT::vectorToHRT(tdVariant, minHRT = 3) # calculate the HRTList
hrtlVarParams <- RHRT::getResults(hrtlVar) # get the averaged HRT parameters
```

Other useful methods of HRTList:

- `getPositions` returns the indices of the coupling intervals of the found HRT objects in your vector
- `getHRTParamsAll` returns TO and TS for all HRT objects (except for the averaged HRT) in HRTList as matrix

## Plot

You can plot either a single HRT object or an HRTList. For the latter the averaged HRT object is plotted in dark tone while the other HRT objects are plotted behind in light tone. TO and TS are labeled for the HRT object or the averaged HRT object, respectively.

```{r,  fig.width=7, fig.height=4}
RHRT::plot(hrtlVar@HRTs[[1]], main = "One HRT object")
```

```{r,  fig.width=7, fig.height=4}
RHRT::plot(hrtlVar, main = "All HRT objects in an HRTList object")
```
In either case you can specify whether you want the plot to be cropped vertically so TO and TS can be better inspected. Consequently CPI and CMI are not visible.

```{r,  fig.width=7, fig.height=4}
RHRT::plot(hrtlVar, cropped = FALSE, main = "Not cropped")
```

TT is hidden by default, but can be displayed.
```{r,  fig.width=7, fig.height=4}
RHRT::plot(hrtlVar, cropped = FALSE, TT=TRUE)
```
